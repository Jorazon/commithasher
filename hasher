#!/bin/bash

TARGET="000" # The target pattern (3 leading zeros)
# Retrieve the original message, timestamps and tree object from the HEAD commit
MESSAGE=$(git log -1 --pretty=format:"%s")
AUTHOR_DATE=$(git log -1 --format=%aI)
COMMITTER_DATE=$(git log -1 --format=%cI)
TREE=$(git write-tree)

# ASCII characters set: 0-9, A-F
CHARS=({0..9} {A..F})

# Function to generate random trailing data
generate_trailing_data() {
  TRAILING=""
  for i in {1..6}; do  # Length of trailing data, adjust as needed
    TRAILING+="${CHARS[RANDOM % ${#CHARS[@]}]}"
  done
  echo "$TRAILING"
}

# Setup for braille status indicator
braille_chars=("⠇" "⠋" "⠙" "⠸" "⠴" "⠦")
i=0

echo -ne "  Finding a cool hash\r"

while true; do
  # Update status indicator
  echo -ne "${braille_chars[$((i % ${#braille_chars[@]}))]}\r"
  ((i++))

  # Generate trailing characters
  TRAILING_DATA=$(generate_trailing_data)

  # New commit message
  NEW_MESSAGE="$MESSAGE #$TRAILING_DATA"

  # Create a new commit with `git commit-tree`
  HASH=$(GIT_AUTHOR_DATE="$AUTHOR_DATE" GIT_COMMITTER_DATE="$COMMITTER_DATE" \
    git commit-tree "$TREE" -p HEAD~1 -m "$NEW_MESSAGE")

  # Check if the hash matches the required pattern
  if [[ "$HASH" == $TARGET* ]]; then
    # Replace previous HEAD with new commit
    git reset --soft "$HASH"
    echo "Found matching hash: $HASH"
    echo "Amending commit with #$TRAILING_DATA"
    break
  fi
done
